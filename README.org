#+TITLE:     Viper Sandbox
#+AUTHOR:    Frederick Z. Cai
#+DESCRIPTION: Verifiable Presentation Sandbox
#+LANGUAGE: en
#+STARTUP:  indent
#+OPTIONS:  H:4 num:nil toc:2 p:t

#+HTML: <div align="center">
#+HTML:   <div>
#+HTML:     An Express app that provides utilities for digital presentations.
#+HTML:   </div>
#+HTML:   </br>
#+HTML:   <a href="https://opensource.org/licenses/Apache-2.0">
#+HTML:     <img src="https://img.shields.io/badge/License-Apache%202.0-blue.svg"
#+HTML:          alt="license-apache-2.0" />
#+HTML:   </a>
#+HTML: </div>

* Installation

** Create a file called =.env.local= in the project's root directory

Follow the [[https://developer.apple.com/documentation/walletpasses/building_a_pass][Apple Developer Guide]] to generate a Signing Certificate.

#+BEGIN_SRC conf
# Double quote multi-line strings and use the \n for newlines
# https://github.com/bkeepers/dotenv#multi-line-values
PASS_IOS_WWDR={{ Apple WWDR CA Certificate PEM }}
PASS_IOS_SIGNER_CERT={{ Signer Certificate PEM }}
PASS_IOS_SIGNER_KEY={{ Signer Key PEM }}
PASS_IOS_SIGNER_KEY_PASS={{ Signer Key Passphrase }}

# Create a Apple Pass Type Identifier
PASS_IOS_TEAM_ID={{ Apple Team Identifier }}
PASS_IOS_PASS_TYPE_ID={{ Pass Type Identifier }}
#+END_SRC

** Launch the application locally by running the following command

#+BEGIN_SRC sh :evel no
# At the project root
yarn install

# Run the application in DEV mode
PORT=3000 yarn start:dev
#+END_SRC

** Send a GET request to the server to generate a Sample Wallet Pass
#+BEGIN_SRC ts :results none
import got from 'got';
import open from 'open';
import { URL, URLSearchParams } from 'url';
import { createWriteStream } from 'fs';

(async () => {
  const qs = new URLSearchParams({
    templateId: "dcc",
    barcode: "HC1:..."
  });
  const stream = got(`http://localhost:3000/viper/pass/ios?${qs}`, { isStream: true });
  const fileName = "/tmp/viper-pass.pkpass";
  stream.pipe(createWriteStream(fileName));
  stream.on('end', () => open(fileName)) // Opens the downloaded file in Pass Viewer
})();
#+END_SRC
